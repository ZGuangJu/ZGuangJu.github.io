(window.webpackJsonp=window.webpackJsonp||[]).push([[172],{663:function(t,s,a){"use strict";a.r(s);var n=a(2),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"知识储备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#知识储备"}},[t._v("#")]),t._v(" 知识储备")]),t._v(" "),a("ul",[a("li",[t._v("掌握 "),a("code",[t._v("ES Modules")]),t._v(" 特性")]),t._v(" "),a("li",[t._v("了解 "),a("code",[t._v("HTTP 2")]),t._v(" 标准")])]),t._v(" "),a("h2",{attrs:{id:"相关介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#相关介绍"}},[t._v("#")]),t._v(" 相关介绍")]),t._v(" "),a("h3",{attrs:{id:"vite-的定义"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vite-的定义"}},[t._v("#")]),t._v(" Vite 的定义")]),t._v(" "),a("p",[t._v("面向现代浏览器的一个更轻、更快的 "),a("code",[t._v("Web")]),t._v(" 应用打包构建工具，")]),t._v(" "),a("p",[t._v("基于 "),a("code",[t._v("ECMAScript")]),t._v(" 标准原生模块系统（"),a("code",[t._v("ES Modules")]),t._v("）实现。")]),t._v(" "),a("h3",{attrs:{id:"vite-的由来"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vite-的由来"}},[t._v("#")]),t._v(" Vite 的由来")]),t._v(" "),a("p",[t._v("如果应用比较复杂，使用 "),a("code",[t._v("Webpack")]),t._v(" 的开发过程相对没有那么丝滑。")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("Webpack Dev Server")]),t._v(" 冷启动时间会比较长")]),t._v(" "),a("li",[a("code",[t._v("Webpack HMR")]),t._v(" 热更新的反应速度比较慢")])]),t._v(" "),a("h2",{attrs:{id:"快速上手"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#快速上手"}},[t._v("#")]),t._v(" 快速上手")]),t._v(" "),a("p",[a("code",[t._v("Vite")]),t._v(" 官方目前提供了一个比较简单的脚手架："),a("code",[t._v("create-vite-app")]),t._v("，可以使用这个脚手架快速创建一个使用 "),a("code",[t._v("Vite")]),t._v(" 构建的 "),a("code",[t._v("Vue.js")]),t._v(" 应用")]),t._v(" "),a("p",[t._v("创建项目到启动项目：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("yarn create vite"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\ncd "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nyarn\nyarn dev\n")])])]),a("p",[t._v("如果使用 "),a("code",[t._v("npm")]),t._v(":")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("npm init vite"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\ncd "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nnpm i\nnpm run dev\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("P.S")]),t._v(" "),a("p",[a("code",[t._v("npm init")]),t._v(" 或者 "),a("code",[t._v("yarn create")]),t._v(" 是这两个包管理工具提供的新功能，其内部就是自动去安装一个 "),a("code",[t._v("create-<xxx>")]),t._v(" 的模块（临时），然后自动执行这个模块中的 "),a("code",[t._v("bin")]),t._v("。")]),t._v(" "),a("p",[t._v("例如:\n"),a("code",[t._v("yarn create react-app my-react-app")]),t._v(" 就相当于先 "),a("code",[t._v("yarn global add create-react-app")]),t._v("，然后自动执行 "),a("code",[t._v("create-react-app my-react-app")])])]),t._v(" "),a("h3",{attrs:{id:"对比差异点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#对比差异点"}},[t._v("#")]),t._v(" 对比差异点")]),t._v(" "),a("p",[t._v("打开生成的项目过后，你会发现就是一个很普通的 "),a("code",[t._v("Vue.js")]),t._v(" 应用，没有太多特殊的地方。")]),t._v(" "),a("p",[t._v("不过相比于之前 "),a("code",[t._v("vue-cli")]),t._v(" 创建的项目或者是基于 "),a("code",[t._v("Webpack")]),t._v(" 搭建的 "),a("code",[t._v("Vue.js")]),t._v("项目，这里的开发依赖非常简单，只有 "),a("code",[t._v("vite")]),t._v(" 和 "),a("code",[t._v("@vue/compiler-sfc")]),t._v("。")]),t._v(" "),a("p",[a("code",[t._v("vite")]),t._v(" 就是我们今天要介绍的主角，而 "),a("code",[t._v("@vue/compiler-sfc")]),t._v("就是用来编译我们项目中 "),a("code",[t._v(".vue")]),t._v(" 结尾的单文件组件（"),a("code",[t._v("SFC")]),t._v("），它取代的就是 "),a("code",[t._v("Vue.js 2.x")]),t._v(" 时使用的 "),a("code",[t._v("vue-template-compiler")]),t._v("。")]),t._v(" "),a("p",[t._v("再者就是 "),a("code",[t._v("Vue.js")]),t._v(" 的版本是 "),a("code",[t._v("3.0")]),t._v("。这里尤其需要注意："),a("strong",[t._v("Vite 目前只支持 Vue.js 3.0 版本。")])]),t._v(" "),a("blockquote",[a("p",[t._v("如果你想，在后面介绍完实现原理过后，你也可以改造 "),a("code",[t._v("Vite")]),t._v(" 让它支持 "),a("code",[t._v("Vue.js 2.0")]),t._v("。")])]),t._v(" "),a("h3",{attrs:{id:"基础体验"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基础体验"}},[t._v("#")]),t._v(" 基础体验")]),t._v(" "),a("p",[t._v("这里我们所安装的 "),a("code",[t._v("vite")]),t._v(" 模块提供了两个子命令：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("serve")]),t._v("：启动一个用于开发的服务器")]),t._v(" "),a("li",[a("code",[t._v("build")]),t._v("：构建整个项目（上线）")])]),t._v(" "),a("p",[t._v("当我们执行 "),a("code",[t._v("vite serve")]),t._v(" 的时候，你会发现响应速度非常快，几乎就是秒开。")]),t._v(" "),a("p",[t._v("可能单独体验你不会有太明显的感觉，你可以对比使用 "),a("code",[t._v("vue-cli-service")]),t._v("（内部还是 "),a("code",[t._v("Webpack")]),t._v("）启动开发服务器，")]),t._v(" "),a("p",[t._v("当我们对比使用 "),a("code",[t._v("vue-cli-service serve")]),t._v(" 的时候，你会有更明显的感觉。")]),t._v(" "),a("p",[t._v("因为 "),a("code",[t._v("Webpack Dev Server")]),t._v(" 在启动时，需要先 "),a("code",[t._v("build")]),t._v(" 一遍，而 "),a("code",[t._v("build")]),t._v(" 的过程是需要耗费很多时间的。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://s1.ax1x.com/2020/09/18/whZSk4.png",alt:"webpack启动"}})]),t._v(" "),a("p",[t._v("而 "),a("code",[t._v("Vite")]),t._v(" 则完全不同，当我们执行 "),a("code",[t._v("vite serve")]),t._v(" 时，内部直接启动了"),a("code",[t._v("Web Server")]),t._v("，并不会先编译所有的代码文件。")]),t._v(" "),a("p",[t._v("那仅仅是启动 "),a("code",[t._v("Web Server")]),t._v("，速度上自然就快了很多。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://s1.ax1x.com/2020/09/18/whVx7F.jpg",alt:"vite启动"}})]),t._v(" "),a("p",[t._v("但是像 "),a("code",[t._v("Webpack")]),t._v(" 这类工具的做法是将所有模块提前编译、打包进 "),a("code",[t._v("bundle")]),t._v(" 里，换句话说，不管模块是否会被执行，都要被编译和打包到 "),a("code",[t._v("bundle")]),t._v(" 里。随着项目越来越大打包后的 "),a("code",[t._v("bundle")]),t._v(" 也越来越大，打包的速度自然也就越来越慢。")]),t._v(" "),a("p",[a("code",[t._v("Vite")]),t._v(" 利用现代浏览器原生支持 "),a("code",[t._v("ESM")]),t._v(" 特性，省略了对模块的打包。")]),t._v(" "),a("p",[t._v("对于需要编译的文件，"),a("code",[t._v("Vite")]),t._v(" 采用的是另外一种模式：即时编译。")]),t._v(" "),a("p",[t._v("也就是说，只有具体去请求某个文件时才会编译这个文件。")]),t._v(" "),a("p",[t._v("所以，这种「即时编译」的好处主要体现在：按需编译。")]),t._v(" "),a("h3",{attrs:{id:"optimize"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#optimize"}},[t._v("#")]),t._v(" Optimize")]),t._v(" "),a("p",[a("code",[t._v("Vite")]),t._v(" 还提供了一个目前在帮助列表中并没有呈现的一个子命令："),a("code",[t._v("optimize")]),t._v("。")]),t._v(" "),a("p",[t._v("这个命令的作用就是单独的去「优化依赖」。")]),t._v(" "),a("p",[t._v("所谓的「优化依赖」，指的就是自动去把代码中依赖的第三方模块提前编译出来。")]),t._v(" "),a("p",[t._v("例如，我们在代码中通过 "),a("code",[t._v("import")]),t._v(" 载入了 "),a("code",[t._v("vue")]),t._v(" 这个模块，那通过这个命令就会自动将这个模块打包成一个单独的"),a("code",[t._v("ESM bundle")]),t._v(", 放到 "),a("code",[t._v("node_modules/.vite_opt_cache")]),t._v(" 目录中。")]),t._v(" "),a("p",[t._v("这样后续请求这个文件时就不需要再即时去加载了。")]),t._v(" "),a("h3",{attrs:{id:"hmr"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#hmr"}},[t._v("#")]),t._v(" HMR")]),t._v(" "),a("p",[t._v("同样也是模式的问题，热更新的时候，"),a("code",[t._v("Vite")]),t._v(" 只需要立即编译当前所修改的文件即可，所以响应速度非常快。")]),t._v(" "),a("p",[t._v("而 "),a("code",[t._v("Webpack")]),t._v(" 修改某个文件过后，会自动以这个文件为入口重写 "),a("code",[t._v("build")]),t._v(" 一次，所有的涉及到的依赖也都会被加载一遍，所以反应速度会慢很多。")]),t._v(" "),a("h3",{attrs:{id:"build"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#build"}},[t._v("#")]),t._v(" Build")]),t._v(" "),a("p",[a("code",[t._v("Vite")]),t._v(" 在生产模式下打包，需要使用 "),a("code",[t._v("vite build")]),t._v(" 命令。")]),t._v(" "),a("p",[t._v("这个命令内部采用的是 "),a("code",[t._v("Rollup")]),t._v(" 完成的应用打包，最终还是会把文件都提前编译并打包到一起。")]),t._v(" "),a("p",[t._v("对于 "),a("code",[t._v("Code Splitting")]),t._v(" 需求，"),a("code",[t._v("Vite")]),t._v(" 内部采用的就是原生 "),a("code",[t._v("Dynamic imports")]),t._v(" 特性实现的，所以打包结果还是只能够支持现代浏览器。")]),t._v(" "),a("p",[t._v("不过好在 "),a("code",[t._v("Dynamic imports")]),t._v(" 特性是可以有 "),a("code",[t._v("Polyfill")]),t._v(" 的："),a("a",{attrs:{href:"https://github.com/GoogleChromeLabs/dynamic-import-polyfill",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/GoogleChromeLabs/dynamic-import-polyfill"),a("OutboundLink")],1),t._v("，也就是说，只要你想，它也可以运行在相对低版本的浏览器中。")]),t._v(" "),a("h3",{attrs:{id:"打包-or-不打包"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#打包-or-不打包"}},[t._v("#")]),t._v(" 打包 or 不打包")]),t._v(" "),a("p",[a("code",[t._v("Vite")]),t._v(" 的出现，引发了另外一个值得我们思考的问题：究竟还有没有必要打包应用？")]),t._v(" "),a("p",[t._v("之前我们使用 "),a("code",[t._v("Webpack")]),t._v(" 打包应用代码，使之成为一个 "),a("code",[t._v("bundle.js")]),t._v("，主要有两个原因：")]),t._v(" "),a("ol",[a("li",[t._v("浏览器环境并不支持模块化")]),t._v(" "),a("li",[t._v("零散的模块文件会产生大量的 "),a("code",[t._v("HTTP")]),t._v(" 请求")])]),t._v(" "),a("p",[t._v("随着浏览器的对 "),a("code",[t._v("ES")]),t._v(" 标准支持的逐渐完善，第一个问题已经慢慢不存在了。现阶段绝大多数浏览器都是支持 "),a("code",[t._v("ES Modules")]),t._v(" 的。")]),t._v(" "),a("p",[a("img",{attrs:{src:"media/es-modules.png",alt:"es-modules"}})]),t._v(" "),a("p",[t._v("零散模块文件确实会产生大量的 "),a("code",[t._v("HTTP")]),t._v(" 请求，而大量的 "),a("code",[t._v("HTTP")]),t._v(" 请求在浏览器端就会并发请求资源的问题；")]),t._v(" "),a("p",[a("em",[t._v("如上图所示，红色圈出来的请求就是并行请求，但是后面的请求就因为域名链接数已超过限制，而被挂起等待了一段时间。")])]),t._v(" "),a("p",[t._v("在 "),a("code",[t._v("HTTP 1.1")]),t._v(" 的标准下，每次请求都需要单独建立 "),a("code",[t._v("TCP")]),t._v(" 链接，经过完整的通讯过程，非常耗时；")]),t._v(" "),a("p",[t._v("而且每次请求除了请求体中的内容，请求头中也会包含很多数据，大量请求的情况下也会浪费很多资源。")]),t._v(" "),a("p",[t._v("但是这些问题随着 "),a("code",[t._v("HTTP 2")]),t._v(" 的出现，也就不复存在了。")]),t._v(" "),a("p",[t._v("关于 "),a("code",[t._v("HTTP 1.1")]),t._v(" 与 "),a("code",[t._v("HTTP 2")]),t._v(" 之间的差异，可以通过这个链接体验："),a("a",{attrs:{href:"https://http2.akamai.com/demo",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://http2.akamai.com/demo"),a("OutboundLink")],1),t._v("，直观感受下 "),a("code",[t._v("HTTP/2")]),t._v(" 比 "),a("code",[t._v("HTTP/1")]),t._v(" 到底快了多少。")]),t._v(" "),a("p",[t._v("而且不打包也有一个好处，就是可以把按需加载实现到极致。")]),t._v(" "),a("blockquote",[a("p",[t._v("关于 HTTP 2 的详细介绍，可以参考：")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://blog.fundebug.com/2019/03/07/understand-http2-and-http3/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://blog.fundebug.com/2019/03/07/understand-http2-and-http3/"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.digitalocean.com/community/tutorials/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.digitalocean.com/community/tutorials/"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("http-1-1-vs-http-2-what-s-the-difference")])])]),t._v(" "),a("h3",{attrs:{id:"开箱即用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#开箱即用"}},[t._v("#")]),t._v(" 开箱即用")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("TypeScript")]),t._v(" - 内置支持")]),t._v(" "),a("li",[a("code",[t._v("less/sass/stylus/postcss")]),t._v(" - 内置支持（需要单独安装所对应的编译器）")])]),t._v(" "),a("h3",{attrs:{id:"特性小结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#特性小结"}},[t._v("#")]),t._v(" 特性小结")]),t._v(" "),a("p",[a("code",[t._v("Vite")]),t._v(" 带来的优势主要体现在提升开发者在开发过程中的体验。")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("Dev Server")]),t._v(" 无需等待，即时启动；")]),t._v(" "),a("li",[t._v("几乎实时的模块热更新；")]),t._v(" "),a("li",[t._v("所需文件按需编译，避免编译用不到的文件；")]),t._v(" "),a("li",[t._v("开箱即用，避免各种 "),a("code",[t._v("Loader")]),t._v(" 和 "),a("code",[t._v("Plugin")]),t._v(" 的配置；")])]),t._v(" "),a("h2",{attrs:{id:"实现原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现原理"}},[t._v("#")]),t._v(" 实现原理")]),t._v(" "),a("p",[a("code",[t._v("Vite")]),t._v(" 的核心功能："),a("code",[t._v("Static Server")]),t._v(" + "),a("code",[t._v("Compile")]),t._v(" + "),a("code",[t._v("HMR")])]),t._v(" "),a("p",[t._v("核心思路：")]),t._v(" "),a("ol",[a("li",[t._v("将当前项目目录作为静态文件服务器的根目录")]),t._v(" "),a("li",[t._v("拦截部分文件请求\n"),a("ol",[a("li",[t._v("处理代码中 "),a("code",[t._v("import node_modules")]),t._v(" 中的模块")]),t._v(" "),a("li",[t._v("处理 "),a("code",[t._v("vue")]),t._v(" 单文件组件（"),a("code",[t._v("SFC")]),t._v("）的编译")])])]),t._v(" "),a("li",[t._v("通过 "),a("code",[t._v("WebSocket")]),t._v(" 实现 "),a("code",[t._v("HMR")])])]),t._v(" "),a("h3",{attrs:{id:"手写实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#手写实现"}},[t._v("#")]),t._v(" 手写实现")]),t._v(" "),a("p",[t._v("详细参考 "),a("a",{attrs:{href:"my-vite"}},[t._v("my-vite")])]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("#"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("bin"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("env node\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" path "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'path'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Readable "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stream'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Koa "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'koa'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" send "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'koa-send'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" compilerSfc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@vue/compiler-sfc'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" cwd "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cwd")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("streamToString")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("stream")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reject")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" chunks "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  stream"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'data'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("chunk")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" chunks"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chunk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  stream"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'end'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("concat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chunks"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("toString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'utf8'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  stream"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reject"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Koa")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 重写请求路径，/@modules/xxx => /node_modules/")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("startsWith")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/@modules/'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" moduleName "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("substr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// => vue")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" modulePkg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cwd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'node_modules'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" moduleName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'package.json'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/node_modules'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" moduleName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" modulePkg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 根据请求路径得到相应文件 /index.html")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ctx.path // http://localhost:3080/")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ctx.body = 'my-vite'")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" root"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" cwd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" index"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'index.html'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 有可能还需要额外处理相应结果")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// .vue 文件请求的处理，即时编译")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("endsWith")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.vue'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" contents "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("streamToString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" descriptor "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" compilerSfc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("contents"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" code\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      code "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" descriptor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("content\n      code "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("replace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/export\\s+default\\s+/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'const __script = '")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      code "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('\n  import { render as __render } from "')]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('?type=template"\n  __script.render = __render\n  export default __script')]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// console.log(code)")]),t._v("\n      ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'application/javascript'")]),t._v("\n      ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Readable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'template'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" templateRender "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" compilerSfc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("compileTemplate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" source"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" descriptor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("template"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("content "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      code "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" templateRender"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("code\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'application/javascript'")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Readable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 替换代码中特殊位置")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'application/javascript'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" contents "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("streamToString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" contents\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("replace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/(from\\s+['\"])(?![\\.\\/])/g")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'$1/@modules/'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("replace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/process\\.env\\.NODE_ENV/g")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\"production\"'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3080")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Server running @ http://localhost:3080'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("h2",{attrs:{id:"license"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#license"}},[t._v("#")]),t._v(" License")]),t._v(" "),a("p",[a("a",{attrs:{href:"LICENSE"}},[t._v("MIT")])]),t._v(" "),a("p",[t._v("转载自")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://zce.me",target:"_blank",rel:"noopener noreferrer"}},[t._v("汪磊"),a("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=e.exports}}]);